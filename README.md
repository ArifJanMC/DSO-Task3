# Ansible Playbook для развертывания Docker и приложений

Этот Ansible playbook автоматизирует установку Docker Engine, развертывание приложения Book Catalog и GitLab с использованием Docker Compose, с поддержкой HTTPS.

## Особенности

- Установка Docker Engine на Linux системы с SELinux
- Развертывание приложения Book Catalog с использованием:
  - Flask (Python)
  - PostgreSQL
  - Nginx для проксирования и HTTPS
- Развертывание GitLab с поддержкой HTTPS
- Все сервисы работают через безопасное соединение (HTTPS)
- Автоматическое клонирование кода из репозитория

## Требования

- Хост с Linux на базе RedHat/CentOS/Fedora с SELinux
- Ansible 2.9+
- Доступ к интернету для скачивания пакетов и образов Docker
- Минимум 8 ГБ оперативной памяти (GitLab требователен к ресурсам)

## Структура проекта

```
ansible-docker-deploy/
├── inventories/
│   └── hosts                           # Инвентарный файл Ansible
├── roles/
│   ├── docker/                         # Роль для установки Docker
│   ├── app-deploy/                     # Роль для развертывания приложения
│   └── gitlab-deploy/                  # Роль для развертывания GitLab
├── vars/
│   └── main.yml                        # Переменные для всех ролей
├── playbook.yml                        # Основной playbook
└── README.md                           # Документация
```

## Настройка и использование

### 1. Подготовка

Клонируйте этот репозиторий на управляющую машину:

```bash
git clone https://github.com/username/ansible-docker-deploy.git
cd ansible-docker-deploy
```

### 2. Настройка переменных

Отредактируйте файл `vars/main.yml` при необходимости:

- Настройте пароли и секретные ключи
- Измените порты или пути к файлам
- Настройте домены для приложения и GitLab

### 3. Запуск playbook

Для запуска на локальной машине:

```bash
ansible-playbook -i inventories/hosts playbook.yml
```

Для запуска на удаленном сервере, измените файл `inventories/hosts` и запустите:

```bash
ansible-playbook -i inventories/hosts playbook.yml
```

### 4. Запуск отдельных ролей

Вы можете запустить отдельные роли, используя теги:

```bash
# Только установка Docker
ansible-playbook -i inventories/hosts playbook.yml --tags "docker"

# Только развертывание приложения
ansible-playbook -i inventories/hosts playbook.yml --tags "app"

# Только развертывание GitLab
ansible-playbook -i inventories/hosts playbook.yml --tags "gitlab"
```

## Проверка работоспособности

### Приложение Book Catalog

1. Откройте в браузере: `https://ваш-сервер/`
2. Протестируйте API:
   ```bash
   # Проверка доступности API
   curl -k https://ваш-сервер/api/health
   
   # Добавление нового автора
   curl -k -X POST https://ваш-сервер/api/authors \
     -H "Content-Type: application/json" \
     -d '{"name":"Test Author","bio":"Test Bio"}'
   ```

### GitLab

1. Откройте в браузере: `https://ваш-сервер:8443/`
2. Войдите с данными:
   - Логин: `root`
   - Пароль: значение переменной `gitlab_root_password` из `vars/main.yml`

## Безопасность

- Все сервисы настроены для работы через HTTPS
- Используются самоподписанные сертификаты (для продакшена рекомендуется заменить на сертификаты от доверенного центра сертификации)
- Пароли хранятся в открытом виде в `vars/main.yml` (для продакшена рекомендуется использовать Ansible Vault)

## Устранение неполадок

### GitLab не запускается

GitLab требует значительных ресурсов. Убедитесь, что на сервере достаточно оперативной памяти (минимум 4 ГБ) и свободного места на диске (минимум 10 ГБ).

### Проблемы с SSL-сертификатами

Браузеры будут показывать предупреждение о ненадежном соединении, так как используются самоподписанные сертификаты. Для обхода этого:
- Добавьте исключение безопасности в браузере
- Используйте параметр `-k` при использовании curl
- Для продакшена замените сертификаты на действительные

### Ошибки доступа к Docker

Если playbook выполнен успешно, но вы не можете выполнять команды Docker без sudo, перезагрузите сервер или перелогиньтесь для применения изменений в группах.